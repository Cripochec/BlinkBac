#cloud-config
users: []
packages:
  - python3-pip
  - python3-venv
  - git
  - supervisor

runcmd:
  # 1. Копирование проекта на сервер и запуск
  - cd /root
  - git clone https://github.com/Cripochec/FlopyBacgit
  - cd FlopyBac
  - python3 -m venv venv
  - source venv/bin/activate
  - pip install -r requirements.txt
  - gunicorn --workers 3 wsgi:app &

  # 2. Настройка автообновления проекта при обновлении на GitHub
  - echo '#!/bin/sh' > /root/FlopyBac/git_update_hook.sh
  - echo 'cd /root/FlopyBac' >> /root/FlopyBac/git_update_hook.sh
  - echo 'git pull' >> /root/FlopyBac/git_update_hook.sh
  - echo 'source venv/bin/activate' >> /root/FlopyBac/git_update_hook.sh
  - echo 'pip install -r requirements.txt' >> /root/FlopyBac/git_update_hook.sh
  - echo 'kill $(lsof -t -i:8000)' >> /root/FlopyBac/git_update_hook.sh
  - echo 'gunicorn --workers 3 wsgi:app &' >> /root/FlopyBac/git_update_hook.sh
  - chmod +x /root/FlopyBac/git_update_hook.sh

  # 3. Настройка Flask маршрута для обработки Webhook
  - echo 'from flask import Flask, request' >> /root/FlopyBac/app.py
  - echo 'import os' >> /root/FlopyBac/app.py
  - echo '@app.route("/git_update_hook", methods=["POST"])' >> /root/FlopyBac/app.py
  - echo 'def git_update():' >> /root/FlopyBac/app.py
  - echo '    os.system("/root/FlopyBac/git_update_hook.sh")' >> /root/FlopyBac/app.py
  - echo '    return "Updated", 200' >> /root/FlopyBac/app.py

  # 4. Настройка Supervisor для постоянного запуска проекта
  - echo '[program:FlopyBac]' > /etc/supervisor/conf.d/FlopyBac.conf
  - echo 'command=/root/FlopyBac/venv/bin/gunicorn --workers 3 wsgi:app' >> /etc/supervisor/conf.d/FlopyBac.conf
  - echo 'directory=/root/FlopyBac' >> /etc/supervisor/conf.d/FlopyBac.conf
  - echo 'user=root' >> /etc/supervisor/conf.d/FlopyBac.conf
  - echo 'autostart=true' >> /etc/supervisor/conf.d/FlopyBac.conf
  - echo 'autorestart=true' >> /etc/supervisor/conf.d/FlopyBac.conf

  # Запускаем Supervisor
  - supervisorctl reread
  - supervisorctl update
  - supervisorctl start FlopyBac
